import streamlit as st
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI
from langchain_core.messages import SystemMessage, HumanMessage

# ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
load_dotenv()

def get_llm_response(user_message, selected_role):
    """LLMã‹ã‚‰ã®å›ç­”ã‚’å–å¾—ã™ã‚‹é–¢æ•°"""
    # ãƒ¢ãƒ‡ãƒ«ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨æ„
    llm = ChatOpenAI(model_name="gpt-4o-mini", temperature=0.5)
    
    # é¸æŠã•ã‚ŒãŸå½¹å‰²ã«å¿œã˜ã¦ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åˆ†å²
    if selected_role == "ç®¡ç†æ¥­å‹™ä¸»ä»»è€…":
        system_message = """
        ã‚ãªãŸã¯ãƒãƒ³ã‚·ãƒ§ãƒ³ç®¡ç†æ¥­å‹™ä¸»ä»»è€…ã§ã™ã€‚å®Ÿå‹™çš„ãªè¦³ç‚¹ã‹ã‚‰ã€
        ç¾å ´ã§ç™ºç”Ÿã™ã‚‹æ—¥å¸¸çš„ãªç®¡ç†æ¥­å‹™ã«é–¢ã™ã‚‹è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚
        å…·ä½“çš„ãªå¯¾å¿œæ‰‹é †ã‚„å®Ÿå‹™çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
        """
    else:
        system_message = """
        ã‚ãªãŸã¯ãƒãƒ³ã‚·ãƒ§ãƒ³ç®¡ç†å£«ã§ã™ã€‚æ³•å¾‹çš„ãƒ»å°‚é–€çš„ãªè¦³ç‚¹ã‹ã‚‰ã€
        ç®¡ç†çµ„åˆé‹å–¶ã‚„é•·æœŸçš„ãªèª²é¡Œã«é–¢ã™ã‚‹è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚
        æ³•çš„æ ¹æ‹ ã‚„å°‚é–€çš„ãªè¦‹è§£ã‚’å«ã‚ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚
        """
    
    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã®ç”¨æ„
    messages = [
        SystemMessage(content=system_message),
        HumanMessage(content=user_message)
    ]
    
    # LLMã‹ã‚‰ã®å›ç­”å–å¾—
    response = llm.invoke(messages)
    return response.content

st.title("ãƒãƒ³ã‚·ãƒ§ãƒ³ç®¡ç†æ¥­å‹™ã‚¢ãƒ—ãƒª: ç¾å ´ç®¡ç†æ¥­å‹™ç”¨")

st.write("##### å‹•ä½œãƒ¢ãƒ¼ãƒ‰1: ç®¡ç†æ¥­å‹™ä¸»ä»»è€…ã«ã‚ˆã‚‹å›ç­”")
st.write("ç¾å ´ã§ç™ºç”Ÿã—ãŸå•é¡Œã‚’ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã™ã‚‹ã¨ã€ç®¡ç†æ¥­å‹™ä¸»ä»»è€…ã®è¦–ç‚¹ã‹ã‚‰å®Ÿå‹™çš„ãªå›ç­”ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚")
st.write("##### å‹•ä½œãƒ¢ãƒ¼ãƒ‰2: ãƒãƒ³ã‚·ãƒ§ãƒ³ç®¡ç†å£«ã«ã‚ˆã‚‹å›ç­”")
st.write("ç¾å ´ã§ç™ºç”Ÿã—ãŸå•é¡Œã‚’ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã™ã‚‹ã¨ã€ãƒãƒ³ã‚·ãƒ§ãƒ³ç®¡ç†å£«ã®è¦–ç‚¹ã‹ã‚‰å°‚é–€çš„ãªå›ç­”ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚")

selected_item = st.radio(
    "å›ç­”è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚",
    ["ç®¡ç†æ¥­å‹™ä¸»ä»»è€…", "ãƒãƒ³ã‚·ãƒ§ãƒ³ç®¡ç†å£«"]
)

st.divider()

if selected_item == "ç®¡ç†æ¥­å‹™ä¸»ä»»è€…":
    input_message = st.text_area(
        label="ç¾å ´ã§ç™ºç”Ÿã—ãŸå•é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
        height=150,
        placeholder="ä¾‹: å…±ç”¨éƒ¨åˆ†ã®é›»çƒãŒåˆ‡ã‚Œã¦ã„ã‚‹ã¨ã®é€£çµ¡ãŒã‚ã‚Šã¾ã—ãŸã€‚"
    )

else:
    input_message = st.text_area(
        label="ç¾å ´ã§ç™ºç”Ÿã—ãŸå•é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
        height=150,
        placeholder="ä¾‹: ç®¡ç†çµ„åˆã®ç·ä¼šã§ä¿®ç¹•ç©ç«‹é‡‘ã®å€¤ä¸Šã’ã«ã¤ã„ã¦è³ªå•ãŒã‚ã‚Šã¾ã—ãŸã€‚"
    )

if st.button("å›ç­”ã‚’å–å¾—"):
    st.divider()

    if input_message:
        with st.spinner('å›ç­”ã‚’ç”Ÿæˆä¸­...'):
            # LLMã‹ã‚‰å›ç­”ã‚’å–å¾—
            try:
                response = get_llm_response(input_message, selected_item)
                
                if selected_item == "ç®¡ç†æ¥­å‹™ä¸»ä»»è€…":
                    st.write("### ğŸ“‹ ç®¡ç†æ¥­å‹™ä¸»ä»»è€…ã‹ã‚‰ã®å›ç­”")
                else:
                    st.write("### ğŸ¢ ãƒãƒ³ã‚·ãƒ§ãƒ³ç®¡ç†å£«ã‹ã‚‰ã®å›ç­”")
                
                st.info(f"**ã”è³ªå•å†…å®¹:** {input_message}")
                st.markdown(response)
                
            except Exception as e:
                st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
                st.error("OpenAI APIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    else:
        st.error("å•é¡Œå†…å®¹ã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰ã€Œå›ç­”ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚")